@model WebApplication1.VMs.BorrowCartVM
@{
    ViewData["Title"] = "Giỏ mượn";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link rel="stylesheet" href="~/css/library-home.css" />

<div class="container" style="margin-top:20px;">
    <div class="section-title" style="margin-bottom:12px;">
        <h3>🧺 Giỏ mượn</h3>
        <span class="muted">Chọn đầu sách, tăng/giảm số lượng rồi lập phiếu mượn</span>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert success">@TempData["Success"]</div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert danger">@TempData["Error"]</div>
    }

    @if (Model.Items.Count == 0)
    {
        <div class="empty">
            <b>Giỏ mượn đang trống.</b>
            <div class="muted">Vào trang Sách và bấm “Thêm vào giỏ”.</div>
            <div style="margin-top:10px;">
                <a class="btn primary" asp-controller="Book" asp-action="Index">📚 Xem sách</a>
            </div>
        </div>
    }
    else
    {
        <div class="card">
            <table class="cart-table">
                <thead>
                    <tr>
                        <th style="width:60px;">Chọn</th>
                        <th>Đầu sách</th>
                        <th style="width:160px;">Thể loại</th>
                        <th style="width:180px;">NXB</th>
                        <th style="width:130px;">Còn mượn</th>
                        <th style="width:220px;">Số lượng</th>
                        <th style="width:110px;"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var it in Model.Items)
                    {
                        var disablePlus = it.Qty >= it.Available;
                        var disableMinus = it.Qty <= 1;

                        <tr>
                            <td>
                                <form asp-controller="Borrow" asp-action="ToggleSelect" method="post">
                                    <input type="hidden" name="dauSachId" value="@it.DauSachId" />
                                    <input type="hidden" name="selected" value="@(it.Selected ? "false" : "true")" />
                                    <input type="checkbox" @(it.Selected ? "checked" : "") onchange="this.form.submit()" />
                                </form>
                            </td>

                            <td>
                                <b>@it.TieuDe</b>
                                @* <div class="muted" style="font-size:12px;">ID: @it.DauSachId</div> *@
                            </td>

                            <td>@(it.TheLoai ?? "-")</td>
                            <td>@(it.NXB ?? "-")</td>

                            <td>
                                <span class="pill">@it.Available</span>
                            </td>

                            <td>
                                <div class="qty">
                                    <form asp-controller="Borrow" asp-action="Minus" method="post">
                                        <input type="hidden" name="dauSachId" value="@it.DauSachId" />
                                        <button class="qty-btn" type="submit" @(disableMinus ? "disabled" : "")>−</button>
                                    </form>

                                    <div class="qty-num">@it.Qty</div>

                                    <form asp-controller="Borrow" asp-action="Plus" method="post">
                                        <input type="hidden" name="dauSachId" value="@it.DauSachId" />
                                        <button class="qty-btn" type="submit" @(disablePlus ? "disabled" : "")>+</button>
                                    </form>
                                </div>

                                <div class="muted" style="font-size:12px; margin-top:6px;">
                                    Tối đa: @it.Available
                                </div>
                            </td>

                            <td class="text-right">
                                <form asp-controller="Borrow" asp-action="Remove" method="post">
                                    <input type="hidden" name="dauSachId" value="@it.DauSachId" />
                                    <button class="btn" type="submit">🗑 Xóa</button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <div class="cart-footer">
                <div>
                    <b>Tổng SL (đã chọn):</b> @Model.TotalSelectedQty
                </div>

                <div style="display:flex; gap:10px; align-items:center;">
                    <form asp-controller="Borrow" asp-action="Clear" method="post">
                        <button class="btn" type="submit">Xóa giỏ</button>
                    </form>

                    <form asp-controller="Borrow" asp-action="CreateBorrowSlip" method="post" style="display:flex; gap:10px; align-items:center;">
                       
                        <button class="btn primary" type="submit">🧾 Lập phiếu mượn</button>
                    </form>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .alert {
        padding: 12px 14px;
        border-radius: 12px;
        margin-bottom: 12px;
    }

        .alert.success {
            background: rgba(16,185,129,.15);
            border: 1px solid rgba(16,185,129,.3);
        }

        .alert.danger {
            background: rgba(239,68,68,.15);
            border: 1px solid rgba(239,68,68,.3);
        }

    .cart-table {
        width: 100%;
        border-collapse: collapse;
    }

        .cart-table th, .cart-table td {
            padding: 12px 10px;
            border-bottom: 1px solid rgba(255,255,255,.08);
            vertical-align: middle;
        }

    .qty {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .qty-btn {
        width: 38px;
        height: 38px;
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,.15);
        background: transparent;
        color: inherit;
        font-size: 18px;
        cursor: pointer;
    }

        .qty-btn:disabled {
            opacity: .45;
            cursor: not-allowed;
        }

    .qty-num {
        min-width: 34px;
        text-align: center;
        font-weight: 700;
    }

    .cart-footer {
        display: flex;
        justify-content: space-between;
        padding: 14px 10px;
    }

    .text-right {
        text-align: right;
    }
</style>
